@using Domain_Layer.DTOs.ProductVariantDtos
@using Domain_Layer.DTOs.Attribute
@model dynamic

@{
    ViewData["Title"] = "تعديل الـ Variant";
}

@* سطر مهم لضمان عمل الـ AJAX مع الـ Post *@
@Html.AntiForgeryToken()

<div class="container py-4">
    <div class="row">
        <div class="col-md-7">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">تعديل بيانات الـ Variant الأساسية</h5>
                </div>
                <div class="card-body">
                    <form asp-action="UpdateVariant" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="Id" value="@Model.Id" id="variantId" />
                        <input type="hidden" name="ProductId" value="@Model.Productid" />

                        <div class="mb-3">
                            <label class="form-label fw-bold">اسم الـ Variant</label>
                            <input type="text" name="VariantName" class="form-control" value="@Model.VariantName" required />
                        </div>

                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label fw-bold">السعر</label>
                                <input type="number" step="0.01" name="Price" class="form-control" value="@Model.Price" required />
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-bold">المخزون</label>
                                <input type="number" name="Stock" class="form-control" value="@Model.Stock" required />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">الصورة الحالية</label>
                            <div class="mb-2">
                                <img src="@Model.ImageUrl" id="imagePreview" class="rounded border" style="width: 120px; height: 120px; object-fit: cover;" />
                            </div>
                            <label class="form-label">تغيير الصورة (اختياري)</label>
                            <input type="file" name="ImageFile" class="form-control" onchange="previewFile(event)" />
                        </div>

                        <hr />
                        <button type="submit" class="btn btn-success w-100 fw-bold shadow-sm">حفظ التغييرات</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card shadow-sm border-0 border-start border-4 border-warning">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">السمات (Attributes)</h5>
                    <button class="btn btn-sm btn-warning fw-bold" onclick="openAddAttributeModal()">+ Attribute</button>
                </div>
                <div class="card-body">
                    @if (Model.attributeValues != null)
                    {
                        foreach (var attr in Model.attributeValues)
                        {
                            <div class="mb-4 p-3 bg-light rounded shadow-sm border">
                                <div class="d-flex justify-content-between align-items-center mb-2 border-bottom pb-1">
                                    <span class="fw-bold text-primary text-uppercase small">@attr.Name</span>
                                    <button class="btn btn-link btn-sm text-success p-0 text-decoration-none"
                                            onclick="addValueToAttr(@attr.AttributeId, '@attr.Name')">
                                        + Add Value
                                    </button>
                                </div>

                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    @foreach (var val in attr.Values)
                                    {
                                        <div class="badge bg-white text-dark border p-2 d-flex align-items-center shadow-xs">
                                            <span class="me-2">@val.Value</span>
                                            <a href="javascript:void(0)" class="text-danger"
                                               onclick="deleteValue(@Model.Id, @val.Id)" title="حذف">
                                                <i class="bi bi-x-circle-fill">X</i>
                                            </a>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 1. معاينة الصورة
        function previewFile(event) {
            var reader = new FileReader();
            reader.onload = function () {
                var output = document.getElementById('imagePreview');
                output.src = reader.result;
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        // 2. دالة إرسال الـ AJAX الموحدة
        async function sendAttributeRequest(url, data) {
            // سحب التوكن من الصفحة
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token // مهم جداً للأمان في ASP.NET MVC
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message || "تمت العملية بنجاح");
                    location.reload();
                } else {
                    alert("فشل العملية: " + result.message);
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                alert("حدث خطأ في الشبكة أو السيرفر غير متاح");
            }
        }

        // 3. دالة حذف قيمة (Remove)
        function deleteValue(variantId, valueId) {
            if (confirm("هل أنت متأكد من حذف هذه السمة من هذا الـ Variant؟")) {
                const url = '@Url.Action("RemoveAttributeValueIdFromVariant", "ProductVariant")';

                const data = {
                    ProductVariantId: parseInt(variantId),
                    AttributeValueId: parseInt(valueId)
                };

                sendAttributeRequest(url, data);
            }
        }

        // 4. دالة إضافة قيمة (Add)
        function addValueToAttr(attrId, attrName) {
            let valueId = prompt(`أدخل الـ ID الخاص بالقيمة لسمة ${attrName}:`);

            if (valueId && !isNaN(valueId)) {
                const url = '@Url.Action("AddAttributeValueIdToVariant", "ProductVariant")';

                const data = {
                    ProductVariantId: parseInt(document.getElementById('variantId').value),
                    AttributeValueId: parseInt(valueId)
                };

                sendAttributeRequest(url, data);
            } else if (valueId) {
                alert("يرجى إدخال رقم ID صحيح");
            }
        }

        function openAddAttributeModal() {
            alert("هنا يمكنك ربط Modal لاختيار Attribute جديد");
        }
    </script>

    <style>
        .badge i:hover {
            color: #dc3545 !important;
            cursor: pointer;
        }

        .shadow-xs {
            box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
        }

        .badge {
            font-size: 0.9rem;
            font-weight: 500;
        }
    </style>
}
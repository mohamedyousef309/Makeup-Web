@using Domain_Layer.DTOs.ProductDtos
@model ProductDetailsDto

@{
    ViewData["Title"] = Model.Name + " | Pro Makeup Studio";
}

@section Styles {
    <style>
        :root {
            --primary-pink: #d68a8a;
            --primary-hover: #c27676;
            --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --input-bg: #252525;
            --text-light: #ffffff;
            --text-muted: #a0a0a0;
            --accent-gold: #c5a059;
            --danger-red: #ff4d4d;
            --success-green: #28a745;
            --warning-yellow: #ffc107;
            --info-blue: #6a8fd8;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
        }

        /* Product Container */
        .product-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-bottom: 60px;
        }

        @@media (max-width: 992px) {
            .product-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }

        /* Product Image */
        .product-image-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #252525;
            height: 500px;
            overflow: hidden;
            position: relative;
        }

        .image-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .product-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), 
                        transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: opacity, transform;
        }

        .product-image.active {
            opacity: 1;
            transform: scale(1);
            z-index: 2;
        }

        .product-image.loading {
            opacity: 0.3;
            filter: blur(2px);
        }

        .image-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1.2rem;
            opacity: 0;
            transition: opacity 0.8s ease;
            z-index: 1;
        }

        .image-placeholder.active {
            opacity: 1;
            z-index: 2;
        }

        /* Loading Animation */
        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 3px solid rgba(214, 138, 138, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-pink);
            animation: spin 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
            z-index: 10;
            display: none;
        }

        @@keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Product Info */
        .product-info {
            padding: 20px 0;
        }

        .product-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-light);
        }

        .product-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 25px;
        }

        .product-description {
            color: var(--text-muted);
            line-height: 1.6;
            font-size: 1.1rem;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 1px solid #252525;
        }

        /* Options Section */
        .options-section {
            margin-bottom: 30px;
        }

        .option-group {
            margin-bottom: 25px;
        }

        .option-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-title i {
            color: var(--primary-pink);
        }

        .option-values {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .option-value {
            background: var(--input-bg);
            border: 2px solid transparent;
            color: var(--text-light);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
            text-align: center;
        }

            .option-value:hover {
                border-color: var(--primary-pink);
                transform: translateY(-2px);
            }

            .option-value.selected {
                background: rgba(214, 138, 138, 0.2);
                border-color: var(--primary-pink);
                color: var(--primary-pink);
            }

            .option-value.disabled {
                opacity: 0.5;
                cursor: not-allowed;
                border-color: transparent !important;
                transform: none !important;
            }

        /* Variant Options Styling */
        .variant-option {
            min-width: 180px;
            text-align: center;
            padding: 15px;
        }

        .variant-option .option-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .variant-option .option-details {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .variant-option .option-price {
            color: var(--accent-gold);
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Highlight selected variant */
        .variant-option.selected {
            background: rgba(214, 138, 138, 0.2) !important;
            border-color: var(--primary-pink) !important;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(214, 138, 138, 0.2);
        }

        /* Stock Info */
        .stock-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid #252525;
        }

        .stock-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success-green);
        }

        .stock-indicator.out-of-stock {
            background: var(--danger-red);
        }

        .stock-text {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Actions */
        .actions-section {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-add-to-cart {
            flex: 1;
            background: linear-gradient(45deg, var(--primary-pink), var(--accent-gold));
            color: white;
            border: none;
            border-radius: 10px;
            padding: 18px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

            .btn-add-to-cart:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 30px rgba(214, 138, 138, 0.3);
            }

            .btn-add-to-cart:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none !important;
                box-shadow: none !important;
            }

        .btn-wishlist {
            width: 60px;
            background: var(--input-bg);
            border: 1px solid #333;
            color: var(--text-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .btn-wishlist:hover {
                background: #333;
                color: var(--primary-pink);
            }

        /* Selected Options Summary */
        .selected-options-summary {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid #252525;
        }

        .summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .summary-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-title i {
            color: var(--primary-pink);
        }

        .selected-variant-details {
            margin-top: 15px;
        }

        .selected-variant {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid #252525;
            transition: all 0.3s ease;
        }

        .variant-attributes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
        }

        .attribute-badge {
            background: rgba(214, 138, 138, 0.2);
            color: var(--primary-pink);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .variant-price {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-gold);
        }

        /* Available Variants List */
        .variants-summary {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #252525;
        }

        .variants-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .variant-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #252525;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .variant-item:hover {
                border-color: var(--primary-pink);
                transform: translateX(5px);
                background: rgba(214, 138, 138, 0.05);
            }

            .variant-item.selected {
                border-color: var(--primary-pink);
                background: rgba(214, 138, 138, 0.1);
            }

        .variant-item-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .variant-item-name {
            font-weight: 600;
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .variant-item-attributes {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .variant-item-attribute {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .variant-item-price {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-gold);
            min-width: 100px;
            text-align: right;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

            .empty-state i {
                font-size: 4rem;
                color: var(--text-muted);
                margin-bottom: 20px;
                opacity: 0.5;
            }

            .empty-state h4 {
                color: var(--text-light);
                margin-bottom: 10px;
                font-size: 1.5rem;
            }

            .empty-state p {
                color: var(--text-muted);
                margin-bottom: 30px;
                max-width: 400px;
                margin-left: auto;
                margin-right: auto;
            }

        /* Animations */
        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade {
            animation: fadeIn 0.5s ease forwards;
        }

        /* Alert */
        .alert {
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            animation: fadeIn 0.5s ease;
        }

        .alert-info {
            background: rgba(106, 143, 216, 0.2);
            border: 1px solid var(--info-blue);
            color: #8ab4f8;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid var(--success-green);
            color: #6fcf97;
        }

        /* Form hidden elements */
        .hidden-form-elements {
            display: none;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .product-container {
                padding: 20px 15px;
            }

            .product-title {
                font-size: 2rem;
            }

            .product-price {
                font-size: 1.6rem;
            }

            .product-image-container {
                height: 400px;
            }

            .option-value {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-width: 70px;
            }

            .variant-option {
                min-width: 150px;
            }

            .actions-section {
                flex-direction: column;
            }

            .btn-wishlist {
                width: 100%;
                height: 50px;
            }

            .variant-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .variant-item-price {
                text-align: left;
                min-width: auto;
            }
        }

        @@media (max-width: 480px) {
            .product-title {
                font-size: 1.6rem;
            }

            .product-price {
                font-size: 1.4rem;
            }

            .product-image-container {
                height: 300px;
            }

            .option-values {
                justify-content: center;
            }
        }
    </style>
}

<div class="product-container">
    <!-- Success Alert -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show animate-fade" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Info Alert -->
    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show animate-fade" role="alert">
            <i class="bi bi-info-circle me-2"></i>
            @TempData["InfoMessage"]
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Hidden Form for Basket Submission -->
    <form id="addToBasketForm" method="post" action="@Url.Action("AddToBasket", "Basket")" class="hidden-form-elements">
        @Html.AntiForgeryToken()
        
        <!-- Hidden Fields for Basket Data -->
        <input type="hidden" id="formProductId" name="ProductId" value="@Model.Id" />
        <input type="hidden" id="formProductVariantId" name="ProductVariantId" />
        <input type="hidden" id="formVariantImageUrl" name="VariantImageUrl" />
        <input type="hidden" id="formProductName" name="ProductName" value="@Model.Name" />
        <input type="hidden" id="formProductPrice" name="ProductPrice" />
        <input type="hidden" id="formQuantity" name="Quantity" value="1" />
        
        <!-- ProductVariantValues will be added dynamically via JavaScript -->
        <div id="formVariantValuesContainer">
            <!-- Will be populated with selected values -->
        </div>
    </form>

    <div class="product-grid">
        <!-- Product Image -->
        <div class="product-image-section">
            <div class="product-image-container animate-fade">
                <div class="image-wrapper">
                    <!-- Loading spinner -->
                    <div class="image-loading" id="imageLoading"></div>
                    
                    <!-- Main product image -->
                    <img src="@Model.ImageUrl" 
                         alt="@Model.Name" 
                         class="product-image active" 
                         id="mainProductImage" 
                         onload="handleImageLoad(this)" 
                         onerror="handleImageError(this)" />
                    
                    <!-- Variant image (preloaded but hidden) -->
                    <img src="" 
                         alt="" 
                         class="product-image" 
                         id="variantImage" 
                         onload="handleImageLoad(this)" 
                         onerror="handleImageError(this)" />
                         
                    <!-- Placeholder (hidden by default) -->
                    <div class="image-placeholder" id="imagePlaceholder">
                        <i class="bi bi-image"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Info & Options -->
        <div class="product-info">
            <h1 class="product-title animate-fade">@Model.Name</h1>
            
            <div class="product-price animate-fade" style="animation-delay: 0.1s">
                <span id="selectedPrice">Select options to see price</span>
            </div>

            <div class="product-description animate-fade" style="animation-delay: 0.2s">
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    @Model.Description
                }
                else
                {
                    <span class="text-muted">No description available</span>
                }
            </div>

            <!-- Options Selection -->
            @if (Model.AllOptions != null && Model.AllOptions.Any())
            {
                <div class="options-section">
                    @foreach (var optionGroup in Model.AllOptions)
                    {
                        <div class="option-group animate-fade">
                            <div class="option-title">
                                <i class="bi bi-circle-fill"></i>
                                @optionGroup.Name
                            </div>
                            <div class="option-values">
                                @foreach (var value in optionGroup.Values)
                                {
                                    <div class="option-value" 
                                         data-attribute="@optionGroup.Name"
                                         data-value="@value.Value"
                                         data-value-id="@value.Id"
                                         onclick="selectOption('@optionGroup.Name', '@value.Value', @value.Id, this)">
                                        @value.Value
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Available Variants as Options -->
                    @if (Model.Variants != null && Model.Variants.Any())
                    {
                        <div class="option-group animate-fade">
                            <div class="option-title">
                                <i class="bi bi-box"></i>
                                Choose Directly
                            </div>
                            <div class="option-values">
                                @foreach (var variant in Model.Variants)
                                {
                                    <div class="option-value variant-option" 
                                         data-variant-id="@variant.Id"
                                         data-variant-name="@variant.VariantName"
                                         data-variant-image="@variant.VariantImage"
                                         data-variant-price="@variant.Price"
                                         data-variant-stock="@variant.Stock"
                                         onclick="selectVariantDirect('@variant.Id', '@variant.VariantName', '@variant.VariantImage', @variant.Price, @variant.Stock, this)">
                                        <div style="text-align: left;">
                                            <strong>@variant.VariantName</strong><br>
                                            @if (variant.SelectedAttributes != null && variant.SelectedAttributes.Any())
                                            {
                                                @foreach (var attr in variant.SelectedAttributes)
                                                {
                                                    <small>@attr.AttributeName: @attr.Value</small><br>
                                                }
                                            }
                                            <span style="color: var(--accent-gold); font-weight: bold;">@variant.Price.ToString("C")</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Selected Options Summary -->
                <div class="selected-options-summary animate-fade" id="selectedOptionsSummary" style="display: none;">
                    <div class="summary-header">
                        <div class="summary-title">
                            <i class="bi bi-check-circle"></i>
                            Selected Options
                        </div>
                        <div id="stockStatus" class="stock-text"></div>
                    </div>
                    
                    <div id="selectedOptionsList" class="variant-attributes" style="margin-top: 10px;">
                        <!-- سيتم ملؤها بالجافاسكريبت -->
                    </div>
                    
                    <!-- Selected Variant Details -->
                    <div class="selected-variant-details" id="selectedVariantDetails" style="display: none;">
                        <div class="selected-variant">
                            <div class="variant-attributes">
                                <span class="variant-item-name" id="selectedVariantName"></span>
                            </div>
                            <div class="variant-price" id="selectedVariantPrice"></div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="actions-section animate-fade">
                    <button type="button" class="btn-add-to-cart" id="addToCartBtn" onclick="addToCart()" disabled>
                        <i class="bi bi-cart-plus"></i>
                        Add to Cart
                    </button>
                    <button type="button" class="btn-wishlist" onclick="addToWishlist()">
                        <i class="bi bi-heart"></i>
                    </button>
                </div>
            }
            else
            {
                <div class="empty-state animate-fade">
                    <i class="bi bi-inboxes"></i>
                    <h4>No Options Available</h4>
                    <p>This product doesn't have any options configured yet.</p>
                </div>
            }

            <!-- Available Variants Summary (Optional - Keep as backup) -->
            @if (Model.Variants != null && Model.Variants.Any())
            {
                <div class="variants-summary animate-fade">
                    <h3 class="summary-title">
                        <i class="bi bi-box"></i>
                        Available Variants List
                    </h3>
                    <div class="variants-list">
                        @foreach (var variant in Model.Variants)
                        {
                            <div class="variant-item" 
                                 data-variant-id="@variant.Id"
                                 data-variant-image="@variant.VariantImage"
                                 onclick="selectVariantFromList(@Json.Serialize(variant))">
                                <div class="variant-item-info">
                                    <div class="variant-item-name">@variant.VariantName</div>
                                    @if (variant.SelectedAttributes != null && variant.SelectedAttributes.Any())
                                    {
                                        <div class="variant-item-attributes">
                                            @foreach (var attr in variant.SelectedAttributes)
                                            {
                                                <span class="variant-item-attribute">
                                                    @attr.AttributeName: @attr.Value
                                                </span>
                                            }
                                        </div>
                                    }
                                </div>
                                <div class="variant-item-price">
                                    @variant.Price.ToString("C")
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize selected options
            window.selectedOptions = {};
            window.selectedVariant = null;
            window.allVariants = @Html.Raw(Json.Serialize(Model.Variants));
            window.currentImageType = 'main'; // 'main' or 'variant'
            window.imagesLoaded = {
                main: false,
                variant: false
            };

            // Log variants for debugging
            console.log('All variants:', window.allVariants);

            // Function to handle image load
            window.handleImageLoad = function(imgElement) {
                const loadingElement = document.getElementById('imageLoading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
                // Remove loading class
                imgElement.classList.remove('loading');
                
                // Mark as loaded
                if (imgElement.id === 'mainProductImage') {
                    window.imagesLoaded.main = true;
                } else if (imgElement.id === 'variantImage') {
                    window.imagesLoaded.variant = true;
                }
            };

            // Function to handle image error
            window.handleImageError = function(imgElement) {
                const loadingElement = document.getElementById('imageLoading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
                // Hide the broken image and show placeholder
                imgElement.style.display = 'none';
                const placeholder = document.getElementById('imagePlaceholder');
                if (placeholder) {
                    placeholder.classList.add('active');
                    placeholder.style.display = 'flex';
                }
            };

            // Function to select an option
            window.selectOption = function (attributeName, value, valueId, element) {
                const optionValue = element;

                // Check if already selected
                if (optionValue.classList.contains('selected')) {
                    // Deselect
                    optionValue.classList.remove('selected');
                    delete window.selectedOptions[attributeName];
                    
                    // Also deselect any direct variant selection
                    document.querySelectorAll('.variant-option.selected').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    window.selectedVariant = null;
                } else {
                    // Remove selection from other values in same attribute
                    const siblings = optionValue.parentElement.querySelectorAll('.option-value');
                    siblings.forEach(sibling => {
                        sibling.classList.remove('selected');
                    });

                    // Select new value
                    optionValue.classList.add('selected');
                    window.selectedOptions[attributeName] = {
                        value: value,
                        valueId: valueId
                    };
                    
                    // Deselect any direct variant selection
                    document.querySelectorAll('.variant-option.selected').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    window.selectedVariant = null;
                }

                // Update UI based on selection
                updateVariantInfo();
                updateSelectedOptionsSummary();
            };

            // Function to select variant directly from Available Variants
            window.selectVariantDirect = function(variantId, variantName, variantImage, variantPrice, variantStock, element) {
                // Remove selection from all variant options
                document.querySelectorAll('.variant-option.selected').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Select the clicked variant
                element.classList.add('selected');
                
                // Clear individual option selections
                window.selectedOptions = {};
                document.querySelectorAll('.option-value.selected').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Clear variant list selection
                document.querySelectorAll('.variant-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Set the selected variant
                window.selectedVariant = {
                    id: variantId,
                    variantName: variantName,
                    variantImage: variantImage,
                    price: variantPrice,
                    stock: variantStock,
                    selectedAttributes: []
                };
                
                // Update UI
                updateVariantInfo();
                updateSelectedOptionsSummary();
                
                // Update price display
                const priceElement = document.getElementById('selectedPrice');
                priceElement.textContent = '$' + variantPrice.toFixed(2);
                
                // Update form fields
                document.getElementById('formProductPrice').value = variantPrice;
                document.getElementById('formProductVariantId').value = variantId;
                document.getElementById('formVariantImageUrl').value = variantImage;
                
                // Update image
                if (variantImage) {
                    switchImage('variant', variantImage);
                } else {
                    switchImage('main');
                }
                
                // Enable/disable add to cart button
                const addToCartBtn = document.getElementById('addToCartBtn');
                if (variantStock > 0) {
                    addToCartBtn.disabled = false;
                } else {
                    addToCartBtn.disabled = true;
                }
                
                // Update stock status
                const stockStatus = document.getElementById('stockStatus');
                if (stockStatus) {
                    if (variantStock > 0) {
                        stockStatus.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> In Stock (${variantStock} available)`;
                    } else {
                        stockStatus.innerHTML = `<i class="bi bi-x-circle-fill text-danger"></i> Out of Stock`;
                    }
                }
                
                // Update selected variant name and price
                const selectedVariantName = document.getElementById('selectedVariantName');
                const selectedVariantPrice = document.getElementById('selectedVariantPrice');
                if (selectedVariantName && selectedVariantPrice) {
                    selectedVariantName.textContent = variantName;
                    selectedVariantPrice.textContent = '$' + variantPrice.toFixed(2);
                }
            };

            // Function to select variant from the list
            window.selectVariantFromList = function(variant) {
                // Clear previous selections
                window.selectedOptions = {};
                document.querySelectorAll('.option-value.selected').forEach(option => {
                    option.classList.remove('selected');
                });

                // Clear variant-option selections
                document.querySelectorAll('.variant-option.selected').forEach(option => {
                    option.classList.remove('selected');
                });

                // Select the clicked variant
                document.querySelectorAll('.variant-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                
                const variantElement = document.querySelector(`[data-variant-id="${variant.id}"]`);
                if (variantElement) {
                    variantElement.classList.add('selected');
                }

                // Set selected variant
                window.selectedVariant = variant;

                // Select all options for this variant
                if (variant.selectedAttributes && variant.selectedAttributes.length > 0) {
                    variant.selectedAttributes.forEach(attr => {
                        // Find and select the corresponding option
                        const optionElement = document.querySelector(`.option-value[data-attribute="${attr.attributeName}"][data-value="${attr.value}"]`);
                        if (optionElement) {
                            optionElement.classList.add('selected');
                            window.selectedOptions[attr.attributeName] = {
                                value: attr.value,
                                valueId: attr.id
                            };
                        }
                    });
                }

                // Update UI
                updateVariantInfo();
                updateSelectedOptionsSummary();
            };

            // Function to update selected options summary
            function updateSelectedOptionsSummary() {
                const summary = document.getElementById('selectedOptionsSummary');
                const list = document.getElementById('selectedOptionsList');
                const stockStatus = document.getElementById('stockStatus');
                const selectedVariantDetails = document.getElementById('selectedVariantDetails');
                const selectedVariantName = document.getElementById('selectedVariantName');
                const selectedVariantPrice = document.getElementById('selectedVariantPrice');
                
                if (Object.keys(window.selectedOptions).length > 0 || window.selectedVariant) {
                    summary.style.display = 'block';
                    
                    // If we have a direct variant selected
                    if (window.selectedVariant && Object.keys(window.selectedOptions).length === 0) {
                        // Display variant name
                        list.innerHTML = `<span class="attribute-badge">${window.selectedVariant.variantName}</span>`;
                        selectedVariantDetails.style.display = 'block';
                        selectedVariantName.textContent = window.selectedVariant.variantName;
                        selectedVariantPrice.textContent = '$' + window.selectedVariant.price.toFixed(2);
                        
                        // Update stock status
                        if (window.selectedVariant.stock > 0) {
                            stockStatus.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> In Stock (${window.selectedVariant.stock} available)`;
                        } else {
                            stockStatus.innerHTML = `<i class="bi bi-x-circle-fill text-danger"></i> Out of Stock`;
                        }
                    } else if (Object.keys(window.selectedOptions).length > 0) {
                        // Display selected options
                        let html = '';
                        for (const [attributeName, option] of Object.entries(window.selectedOptions)) {
                            html += `<span class="attribute-badge">${attributeName}: ${option.value}</span>`;
                        }
                        list.innerHTML = html;
                        
                        // If variant is selected, show its details
                        if (window.selectedVariant) {
                            selectedVariantDetails.style.display = 'block';
                            selectedVariantName.textContent = window.selectedVariant.variantName;
                            selectedVariantPrice.textContent = '$' + window.selectedVariant.price.toFixed(2);
                            
                            // Update stock status
                            if (window.selectedVariant.stock > 0) {
                                stockStatus.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> In Stock (${window.selectedVariant.stock} available)`;
                            } else {
                                stockStatus.innerHTML = `<i class="bi bi-x-circle-fill text-danger"></i> Out of Stock`;
                            }
                        } else {
                            selectedVariantDetails.style.display = 'none';
                            stockStatus.innerHTML = `<i class="bi bi-info-circle"></i> Please complete all selections`;
                        }
                    }
                } else {
                    summary.style.display = 'none';
                }
            }

            // Function to find matching variant
            window.findMatchingVariant = function () {
                const selectedAttributeIds = Object.values(window.selectedOptions).map(opt => opt.valueId);
                
                for (const variant of window.allVariants) {
                    const variantAttributeIds = variant.selectedAttributes.map(attr => attr.id);
                    
                    // Check if all selected attributes match the variant
                    const allMatch = selectedAttributeIds.every(id => 
                        variantAttributeIds.includes(id)
                    ) && selectedAttributeIds.length === variantAttributeIds.length;
                    
                    if (allMatch) {
                        return variant;
                    }
                }
                
                return null;
            };

            // Function to smoothly switch between images
            function switchImage(newImageType, newImageUrl = null) {
                const mainImage = document.getElementById('mainProductImage');
                const variantImage = document.getElementById('variantImage');
                const placeholder = document.getElementById('imagePlaceholder');
                const loadingElement = document.getElementById('imageLoading');
                
                // Check if we're requesting the same image URL
                if (newImageType === 'variant' && newImageUrl) {
                    if (variantImage.src === newImageUrl && window.currentImageType === 'variant') {
                        // Same variant image is already showing, do nothing
                        return;
                    }
                } else if (newImageType === 'main' && window.currentImageType === 'main') {
                    // Main image is already showing, do nothing
                    return;
                }
                
                // Hide current active image
                if (window.currentImageType === 'main' && mainImage) {
                    mainImage.classList.remove('active');
                    mainImage.style.opacity = '0';
                } else if (window.currentImageType === 'variant' && variantImage) {
                    variantImage.classList.remove('active');
                    variantImage.style.opacity = '0';
                }
                
                // Hide placeholder if showing
                if (placeholder && placeholder.classList.contains('active')) {
                    placeholder.classList.remove('active');
                    placeholder.style.opacity = '0';
                }
                
                // Show loading spinner
                if (loadingElement) {
                    loadingElement.style.display = 'block';
                }
                
                if (newImageType === 'main') {
                    // Show main product image
                    setTimeout(() => {
                        if (mainImage) {
                            // Reset display and opacity
                            mainImage.style.display = 'block';
                            mainImage.style.opacity = '1';
                            
                            // Set alt text
                            mainImage.alt = '@Model.Name';
                            
                            // Show image with animation
                            setTimeout(() => {
                                mainImage.classList.add('active');
                            }, 10);
                            
                            // Hide variant image
                            if (variantImage) {
                                variantImage.style.display = 'none';
                            }
                            
                            // Hide loading
                            if (loadingElement) {
                                loadingElement.style.display = 'none';
                            }
                        }
                        window.currentImageType = 'main';
                    }, 300);
                    
                } else if (newImageType === 'variant' && newImageUrl) {
                    // Check if variant image is already loaded with the same URL
                    if (variantImage.src === newImageUrl && window.imagesLoaded.variant) {
                        // Image already loaded, just switch to it
                        setTimeout(() => {
                            variantImage.style.display = 'block';
                            variantImage.style.opacity = '1';
                            
                            // Show image with animation
                            setTimeout(() => {
                                variantImage.classList.add('active');
                            }, 10);
                            
                            // Hide main image
                            if (mainImage) {
                                mainImage.style.display = 'none';
                            }
                            
                            // Hide loading
                            if (loadingElement) {
                                loadingElement.style.display = 'none';
                            }
                            
                            window.currentImageType = 'variant';
                        }, 300);
                        
                    } else {
                        // Load new variant image
                        variantImage.src = newImageUrl;
                        variantImage.alt = '@Model.Name';
                        variantImage.classList.add('loading');
                        variantImage.style.display = 'block';
                        
                        // Set alt text based on selected attributes
                        if (window.selectedVariant && window.selectedVariant.selectedAttributes) {
                            const attributes = window.selectedVariant.selectedAttributes.map(attr => attr.value).join(', ');
                            variantImage.alt = '@Model.Name - ' + attributes;
                        } else if (window.selectedVariant) {
                            variantImage.alt = window.selectedVariant.variantName;
                        }
                        
                        // Once image loads, show it
                        variantImage.onload = function() {
                            setTimeout(() => {
                                variantImage.classList.remove('loading');
                                variantImage.style.opacity = '1';
                                
                                // Show image with animation
                                setTimeout(() => {
                                    variantImage.classList.add('active');
                                }, 10);
                                
                                // Hide main image
                                if (mainImage) {
                                    mainImage.style.display = 'none';
                                }
                                
                                // Hide loading spinner
                                if (loadingElement) {
                                    loadingElement.style.display = 'none';
                                }
                                
                                window.currentImageType = 'variant';
                                window.imagesLoaded.variant = true;
                            }, 300);
                        };
                        
                        variantImage.onerror = function() {
                            // Show placeholder if image fails to load
                            if (placeholder) {
                                placeholder.style.display = 'flex';
                                placeholder.style.opacity = '1';
                                setTimeout(() => {
                                    placeholder.classList.add('active');
                                }, 10);
                            }
                            if (loadingElement) {
                                loadingElement.style.display = 'none';
                            }
                            
                            // Hide both images
                            if (mainImage) mainImage.style.display = 'none';
                            if (variantImage) variantImage.style.display = 'none';
                        };
                    }
                }
            }

            // Function to update variant information
            window.updateVariantInfo = function () {
                // If we have a direct variant selected, use it
                if (window.selectedVariant && Object.keys(window.selectedOptions).length === 0) {
                    // Update price
                    const priceElement = document.getElementById('selectedPrice');
                    priceElement.textContent = '$' + window.selectedVariant.price.toFixed(2);
                    
                    // Update form fields
                    document.getElementById('formProductPrice').value = window.selectedVariant.price;
                    document.getElementById('formProductVariantId').value = window.selectedVariant.id;
                    document.getElementById('formVariantImageUrl').value = window.selectedVariant.variantImage;
                    
                    // Enable/disable add to cart button
                    const addToCartBtn = document.getElementById('addToCartBtn');
                    if (window.selectedVariant.stock > 0) {
                        addToCartBtn.disabled = false;
                    } else {
                        addToCartBtn.disabled = true;
                    }
                    
                    return;
                }
                
                // Otherwise, use the individual options logic
                const allOptionsSelected = Object.keys(window.selectedOptions).length === @(Model.AllOptions?.Count() ?? 0);
                
                if (allOptionsSelected) {
                    window.selectedVariant = findMatchingVariant();
                    
                    if (window.selectedVariant) {
                        // Update price
                        const priceElement = document.getElementById('selectedPrice');
                        const formattedPrice = '$' + window.selectedVariant.price.toFixed(2);
                        priceElement.textContent = formattedPrice;
                        
                        // Update form fields
                        document.getElementById('formProductPrice').value = window.selectedVariant.price;
                        document.getElementById('formProductVariantId').value = window.selectedVariant.id;
                        document.getElementById('formVariantImageUrl').value = window.selectedVariant.variantImage || '';
                        
                        // Update product image
                        if (window.selectedVariant.variantImage) {
                            switchImage('variant', window.selectedVariant.variantImage);
                        } else {
                            // If variant doesn't have specific image, show main product image
                            switchImage('main');
                        }
                        
                        // Enable add to cart button
                        const addToCartBtn = document.getElementById('addToCartBtn');
                        if (window.selectedVariant.stock > 0) {
                            addToCartBtn.disabled = false;
                        } else {
                            addToCartBtn.disabled = true;
                        }
                    } else {
                        // No matching variant found
                        document.getElementById('selectedPrice').textContent = 'Not Available';
                        document.getElementById('addToCartBtn').disabled = true;
                        
                        // Reset form fields
                        document.getElementById('formProductPrice').value = '';
                        document.getElementById('formProductVariantId').value = '';
                        document.getElementById('formVariantImageUrl').value = '';
                        
                        // Reset to main product image
                        switchImage('main');
                    }
                } else {
                    // Not all options selected
                    document.getElementById('selectedPrice').textContent = 'Select options to see price';
                    document.getElementById('addToCartBtn').disabled = true;
                    
                    // Reset form fields
                    document.getElementById('formProductPrice').value = '';
                    document.getElementById('formProductVariantId').value = '';
                    document.getElementById('formVariantImageUrl').value = '';
                    
                    // Reset to main product image if no options selected
                    if (Object.keys(window.selectedOptions).length === 0 && !window.selectedVariant) {
                        switchImage('main');
                    }
                }
                
                // Update selected options summary
                updateSelectedOptionsSummary();
            };

            // Function to add to cart
            window.addToCart = function () {
                if (!window.selectedVariant) {
                    showAlert('Please select a variant first', 'info');
                    return;
                }

                if (window.selectedVariant.stock <= 0) {
                    showAlert('This variant is out of stock', 'danger');
                    return;
                }

                // Add loading state to button
                const addToCartBtn = document.getElementById('addToCartBtn');
                const originalText = addToCartBtn.innerHTML;
                addToCartBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding...';
                addToCartBtn.disabled = true;

                // Clear existing variant values from form
                const variantValuesContainer = document.getElementById('formVariantValuesContainer');
                variantValuesContainer.innerHTML = '';

                // Add selected variant values to form
                const selectedValues = [];
                
                // If we have selected options individually
                if (Object.keys(window.selectedOptions).length > 0) {
                    for (const [attributeName, option] of Object.entries(window.selectedOptions)) {
                        selectedValues.push(option.value);
                        
                        // Create hidden input for each selected value
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'ProductVariantValues';
                        input.value = option.value;
                        variantValuesContainer.appendChild(input);
                    }
                } else if (window.selectedVariant && window.selectedVariant.variantName) {
                    // If we selected variant directly, use variant name
                    selectedValues.push(window.selectedVariant.variantName);
                    
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'ProductVariantValues';
                    input.value = window.selectedVariant.variantName;
                    variantValuesContainer.appendChild(input);
                }

                console.log('Adding to basket with data:', {
                    ProductId: document.getElementById('formProductId').value,
                    ProductVariantId: document.getElementById('formProductVariantId').value,
                    VariantImageUrl: document.getElementById('formVariantImageUrl').value,
                    ProductVariantValues: selectedValues,
                    ProductName: document.getElementById('formProductName').value,
                    ProductPrice: document.getElementById('formProductPrice').value,
                    Quantity: document.getElementById('formQuantity').value
                });

                // Submit the form
                document.getElementById('addToBasketForm').submit();
            };

            // Function to add to wishlist
            window.addToWishlist = function () {
                const productId = @Model.Id;
                const wishlistBtn = document.querySelector('.btn-wishlist');
                
                // Add animation effect
                wishlistBtn.innerHTML = '<i class="bi bi-heart-fill text-danger"></i>';
                wishlistBtn.style.color = 'var(--danger-red)';
                
                console.log('Adding to wishlist:', productId);
                showAlert('Product added to wishlist!', 'success');
                
                // Reset after animation
                setTimeout(() => {
                    wishlistBtn.innerHTML = '<i class="bi bi-heart"></i>';
                    wishlistBtn.style.color = '';
                }, 1000);
            };

            // Function to show alerts
            function showAlert(message, type) {
                // Remove existing alerts
                const existingAlerts = document.querySelectorAll('.alert');
                existingAlerts.forEach(alert => alert.remove());

                // Create alert element
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                
                let iconClass = 'bi-info-circle';
                if (type === 'success') iconClass = 'bi-check-circle';
                if (type === 'danger') iconClass = 'bi-exclamation-triangle';
                
                alertDiv.innerHTML = `
                    <i class="bi ${iconClass} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                `;

                // Insert alert at the top of container
                const container = document.querySelector('.product-container');
                if (container.firstChild) {
                    container.insertBefore(alertDiv, container.firstChild);
                } else {
                    container.appendChild(alertDiv);
                }

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.style.opacity = '0';
                        setTimeout(() => alertDiv.remove(), 300);
                    }
                }, 5000);
            }

            // Initialize: ensure main image is visible
            setTimeout(() => {
                const mainImage = document.getElementById('mainProductImage');
                if (mainImage && !mainImage.src) {
                    mainImage.src = '@Model.ImageUrl';
                }
            }, 100);
        });
    </script>
}
@using Domain_Layer.DTOs.ProductDtos
@model ProductDetailsDto

@{
    ViewData["Title"] = Model.Name + " | Pro Makeup Studio";
}

@section Styles {
    <style>
        :root {
            --primary-pink: #d68a8a;
            --primary-hover: #c27676;
            --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --input-bg: #252525;
            --text-light: #ffffff;
            --text-muted: #a0a0a0;
            --accent-gold: #c5a059;
            --danger-red: #ff4d4d;
            --success-green: #28a745;
            --warning-yellow: #ffc107;
            --info-blue: #6a8fd8;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
        }

        /* Product Container */
        .product-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-bottom: 60px;
        }

        @@media (max-width: 992px) {
            .product-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }

        /* Product Image */
        .product-image-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #252525;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 500px;
            overflow: hidden;
        }

        .product-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }

        .image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 1.2rem;
        }

        /* Product Info */
        .product-info {
            padding: 20px 0;
        }

        .product-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-light);
        }

        .product-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 25px;
        }

        .product-description {
            color: var(--text-muted);
            line-height: 1.6;
            font-size: 1.1rem;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 1px solid #252525;
        }

        /* Options Section */
        .options-section {
            margin-bottom: 30px;
        }

        .option-group {
            margin-bottom: 25px;
        }

        .option-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-title i {
            color: var(--primary-pink);
        }

        .option-values {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .option-value {
            background: var(--input-bg);
            border: 2px solid transparent;
            color: var(--text-light);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
            text-align: center;
        }

            .option-value:hover {
                border-color: var(--primary-pink);
                transform: translateY(-2px);
            }

            .option-value.selected {
                background: rgba(214, 138, 138, 0.2);
                border-color: var(--primary-pink);
                color: var(--primary-pink);
            }

            .option-value.disabled {
                opacity: 0.5;
                cursor: not-allowed;
                border-color: transparent !important;
                transform: none !important;
            }

        /* Stock Info */
        .stock-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid #252525;
        }

        .stock-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success-green);
        }

        .stock-indicator.out-of-stock {
            background: var(--danger-red);
        }

        .stock-text {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Actions */
        .actions-section {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-add-to-cart {
            flex: 1;
            background: linear-gradient(45deg, var(--primary-pink), var(--accent-gold));
            color: white;
            border: none;
            border-radius: 10px;
            padding: 18px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

            .btn-add-to-cart:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 30px rgba(214, 138, 138, 0.3);
            }

            .btn-add-to-cart:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none !important;
                box-shadow: none !important;
            }

        .btn-wishlist {
            width: 60px;
            background: var(--input-bg);
            border: 1px solid #333;
            color: var(--text-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .btn-wishlist:hover {
                background: #333;
                color: var(--primary-pink);
            }

        /* Variants Summary */
        .variants-summary {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #252525;
        }

        .summary-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .summary-title i {
                color: var(--primary-pink);
            }

        .selected-variant {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid #252525;
        }

        .variant-attributes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
        }

        .attribute-badge {
            background: rgba(214, 138, 138, 0.2);
            color: var(--primary-pink);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .variant-price {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-gold);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

            .empty-state i {
                font-size: 4rem;
                color: var(--text-muted);
                margin-bottom: 20px;
                opacity: 0.5;
            }

            .empty-state h4 {
                color: var(--text-light);
                margin-bottom: 10px;
                font-size: 1.5rem;
            }

            .empty-state p {
                color: var(--text-muted);
                margin-bottom: 30px;
                max-width: 400px;
                margin-left: auto;
                margin-right: auto;
            }

        /* Animations */
        @@keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .animate-fade {
            animation: fadeIn 0.5s ease forwards;
        }

        /* Alert */
        .alert {
            border-radius: 10px;
            margin-bottom: 20px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .alert-info {
            background: rgba(106, 143, 216, 0.2);
            border: 1px solid var(--info-blue);
            color: #8ab4f8;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid var(--success-green);
            color: #6fcf97;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .product-container {
                padding: 20px 15px;
            }

            .product-title {
                font-size: 2rem;
            }

            .product-price {
                font-size: 1.6rem;
            }

            .product-image-container {
                height: 400px;
            }

            .option-value {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-width: 70px;
            }

            .actions-section {
                flex-direction: column;
            }

            .btn-wishlist {
                width: 100%;
                height: 50px;
            }
        }

        @@media (max-width: 480px) {
            .product-title {
                font-size: 1.6rem;
            }

            .product-price {
                font-size: 1.4rem;
            }

            .product-image-container {
                height: 300px;
            }

            .option-values {
                justify-content: center;
            }
        }
    </style>
}

<div class="product-container">
    <!-- Success Alert -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show animate-fade" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Info Alert -->
    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show animate-fade" role="alert">
            <i class="bi bi-info-circle me-2"></i>
            @TempData["InfoMessage"]
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="product-grid">
        <!-- Product Image -->
        <div class="product-image-section">
            <div class="product-image-container animate-fade">
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <img src="@Model.ImageUrl" alt="@Model.Name" class="product-image" />
                }
                else
                {
                    <div class="image-placeholder">
                        <i class="bi bi-image"></i>
                    </div>
                }
            </div>
        </div>

        <!-- Product Info & Options -->
        <div class="product-info">
            <h1 class="product-title animate-fade">@Model.Name</h1>
            
            <div class="product-price animate-fade" style="animation-delay: 0.1s">
                <span id="selectedPrice">Select options to see price</span>
            </div>

            <div class="product-description animate-fade" style="animation-delay: 0.2s">
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    @Model.Description
                }
                else
                {
                    <span class="text-muted">No description available</span>
                }
            </div>

            <!-- Options Selection -->
            @if (Model.AllOptions != null && Model.AllOptions.Any())
            {
                <div class="options-section">
                    @foreach (var optionGroup in Model.AllOptions)
                    {
                        <div class="option-group animate-fade">
                            <div class="option-title">
                                <i class="bi bi-circle-fill"></i>
                                @optionGroup.Name
                            </div>
                            <div class="option-values">
                                @foreach (var value in optionGroup.Values)
                                {
                                    <div class="option-value" 
                                         data-attribute="@optionGroup.Name"
                                         data-value="@value.Value"
                                         data-value-id="@value.Id"
                                         onclick="selectOption('@optionGroup.Name', '@value.Value', @value.Id, this)">
                                        @value.Value
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Stock Info -->
                <div class="stock-info animate-fade" id="stockInfo" style="display: none;">
                    <div class="stock-indicator" id="stockIndicator"></div>
                    <div class="stock-text" id="stockText"></div>
                </div>

                <!-- Actions -->
                <div class="actions-section animate-fade">
                    <button class="btn-add-to-cart" id="addToCartBtn" onclick="addToCart()" disabled>
                        <i class="bi bi-cart-plus"></i>
                        Add to Cart
                    </button>
                    <button class="btn-wishlist" onclick="addToWishlist()">
                        <i class="bi bi-heart"></i>
                    </button>
                </div>
            }
            else
            {
                <div class="empty-state animate-fade">
                    <i class="bi bi-inboxes"></i>
                    <h4>No Options Available</h4>
                    <p>This product doesn't have any options configured yet.</p>
                </div>
            }

            <!-- Selected Variant Summary -->
            @if (Model.Variants != null && Model.Variants.Any())
            {
                <div class="variants-summary animate-fade">
                    <h3 class="summary-title">
                        <i class="bi bi-box"></i>
                        Available Variants
                    </h3>
                    @foreach (var variant in Model.Variants)
                    {
                        <div class="selected-variant">
                            <div class="variant-attributes">
                                @if (variant.SelectedAttributes != null && variant.SelectedAttributes.Any())
                                {
                                    foreach (var attr in variant.SelectedAttributes)
                                    {
                                        <span class="attribute-badge">
                                            @attr.AttributeName: @attr.Value
                                        </span>
                                    }
                                }
                            </div>
                            <div class="variant-price">
                                @variant.Price.ToString("C")
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize selected options
            window.selectedOptions = {};
            window.selectedVariant = null;
            window.allVariants = @Html.Raw(Json.Serialize(Model.Variants));

            // Function to select an option
            window.selectOption = function (attributeName, value, valueId, element) {
                const optionValue = element;

                // Check if already selected
                if (optionValue.classList.contains('selected')) {
                    // Deselect
                    optionValue.classList.remove('selected');
                    delete window.selectedOptions[attributeName];
                } else {
                    // Remove selection from other values in same attribute
                    const siblings = optionValue.parentElement.querySelectorAll('.option-value');
                    siblings.forEach(sibling => {
                        sibling.classList.remove('selected');
                    });

                    // Select new value
                    optionValue.classList.add('selected');
                    window.selectedOptions[attributeName] = {
                        value: value,
                        valueId: valueId
                    };
                }

                // Update UI based on selection
                updateVariantInfo();
            };

            // Function to find matching variant
            window.findMatchingVariant = function () {
                const selectedAttributeIds = Object.values(window.selectedOptions).map(opt => opt.valueId);
                
                for (const variant of window.allVariants) {
                    const variantAttributeIds = variant.selectedAttributes.map(attr => attr.id);
                    
                    // Check if all selected attributes match the variant
                    const allMatch = selectedAttributeIds.every(id => 
                        variantAttributeIds.includes(id)
                    ) && selectedAttributeIds.length === variantAttributeIds.length;
                    
                    if (allMatch) {
                        return variant;
                    }
                }
                
                return null;
            };

            // Function to update variant information
            window.updateVariantInfo = function () {
                const allOptionsSelected = Object.keys(window.selectedOptions).length === @Model.AllOptions.Count();
                
                if (allOptionsSelected) {
                    window.selectedVariant = findMatchingVariant();
                    
                    if (window.selectedVariant) {
                        // Update price
                        document.getElementById('selectedPrice').textContent = 
                            '$' + window.selectedVariant.price.toFixed(2);
                        
                        // Update stock info
                        const stockInfo = document.getElementById('stockInfo');
                        const stockIndicator = document.getElementById('stockIndicator');
                        const stockText = document.getElementById('stockText');
                        const addToCartBtn = document.getElementById('addToCartBtn');
                        
                        stockInfo.style.display = 'flex';
                        
                        if (window.selectedVariant.stock > 0) {
                            stockIndicator.className = 'stock-indicator';
                            stockText.textContent = `In Stock (${window.selectedVariant.stock} available)`;
                            addToCartBtn.disabled = false;
                        } else {
                            stockIndicator.className = 'stock-indicator out-of-stock';
                            stockText.textContent = 'Out of Stock';
                            addToCartBtn.disabled = true;
                        }
                    } else {
                        // No matching variant found
                        document.getElementById('selectedPrice').textContent = 'Not Available';
                        document.getElementById('stockInfo').style.display = 'none';
                        document.getElementById('addToCartBtn').disabled = true;
                    }
                } else {
                    // Not all options selected
                    document.getElementById('selectedPrice').textContent = 'Select options to see price';
                    document.getElementById('stockInfo').style.display = 'none';
                    document.getElementById('addToCartBtn').disabled = true;
                }
            };

            // Function to add to cart
            window.addToCart = function () {
                if (!window.selectedVariant) {
                    showAlert('Please select all options first', 'info');
                    return;
                }

                if (window.selectedVariant.stock <= 0) {
                    showAlert('This variant is out of stock', 'danger');
                    return;
                }

                // Here you would typically make an API call to add to cart
                console.log('Adding to cart:', window.selectedVariant);
                showAlert('Product added to cart successfully!', 'success');
                
                // Simulate API call
                setTimeout(() => {
                    // You can update cart count or show confirmation here
                }, 500);
            };

            // Function to add to wishlist
            window.addToWishlist = function () {
                const productId = @Model.Id;
                console.log('Adding to wishlist:', productId);
                showAlert('Product added to wishlist!', 'success');
            };

            // Function to show alerts
            function showAlert(message, type) {
                // Remove existing alerts
                const existingAlerts = document.querySelectorAll('.alert');
                existingAlerts.forEach(alert => alert.remove());

                // Create alert element
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show animate-fade`;
                alertDiv.innerHTML = `
                    <i class="bi ${type === 'success' ? 'bi-check-circle' : 'danger' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                `;

                // Insert alert at the top of container
                const container = document.querySelector('.product-container');
                if (container.firstChild) {
                    container.insertBefore(alertDiv, container.firstChild);
                } else {
                    container.appendChild(alertDiv);
                }

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }

            // Update unavailable options based on selected variants
            function updateOptionAvailability() {
                // This function would disable options that don't exist in any variant
                // For simplicity, we're showing all options as available
                // In a real implementation, you would check which combinations exist
            }

            // Initial call to update availability
            updateOptionAvailability();
        });
    </script>
}
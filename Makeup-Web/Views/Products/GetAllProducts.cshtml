@using Domain_Layer.DTOs
@using Domain_Layer.DTOs.ProductDtos
@model PaginatedListDto<GetAllProductsDto>

@{
    ViewData["Title"] = "Luxury Shop - Pro Makeup Studio";
    var searchTerm = Context.Request.Query["search"];
    var sortBy = Context.Request.Query["sortBy"];
    var sortDir = Context.Request.Query["sortDir"];
}

@section Styles {
    <style>
        :root {
            --primary-pink: #d68a8a;
            --dark-bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --input-bg: #252525;
            --text-light: #ffffff;
            --text-muted: #a0a0a0;
            --accent-gold: #c5a059;
            --danger-red: #ff4d4d;
            --success-green: #2ecc71;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
        }

        .shop-header {
            padding: 60px 0 30px;
            text-align: center;
            background: linear-gradient(to bottom, #1a1a1a 0%, #0f0f0f 100%);
            margin-bottom: 30px;
            border-bottom: 1px solid #222;
        }

        .shop-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem;
            font-weight: 800;
            text-transform: uppercase;
            background: linear-gradient(45deg, #fff 30%, var(--primary-pink) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }

        .shop-subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin-top: 10px;
            font-weight: 300;
        }

        .filter-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #252525;
        }

        .form-control-custom {
            background: var(--input-bg) !important;
            border: 1px solid #333 !important;
            color: var(--text-light) !important;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

            .form-control-custom:focus {
                border-color: var(--primary-pink) !important;
                box-shadow: 0 0 0 3px rgba(214, 138, 138, 0.1) !important;
            }

        .input-group-text {
            background: var(--input-bg) !important;
            border: 1px solid #333 !important;
            color: var(--text-muted) !important;
            border-radius: 12px 0 0 12px !important;
        }

        .product-card {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid #252525;
            overflow: hidden;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

            .product-card:hover {
                transform: translateY(-10px);
                border-color: var(--primary-pink);
                box-shadow: 0 20px 40px rgba(214, 138, 138, 0.1);
            }

        .img-wrapper {
            aspect-ratio: 1/1;
            background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .product-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .product-card:hover .product-img {
            transform: scale(1.05);
        }

        .product-info {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .product-category {
            color: var(--primary-pink);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .product-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 12px;
            line-height: 1.3;
            height: 60px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-description {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
            flex: 1;
            height: 80px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .product-actions {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* تنسيق أزرار الأدمن */
        .admin-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .btn-admin {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-edit {
            background: rgba(214, 138, 138, 0.1);
            border: 1px solid var(--primary-pink);
            color: var(--primary-pink);
        }

            .btn-edit:hover {
                background: var(--primary-pink);
                color: white;
            }

        .btn-delete {
            background: rgba(255, 77, 77, 0.1);
            border: 1px solid var(--danger-red);
            color: var(--danger-red);
        }

            .btn-delete:hover {
                background: var(--danger-red);
                color: white;
            }

        /* زر التفاصيل */
        .btn-details {
            background: transparent;
            color: var(--text-light);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 12px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

            .btn-details:hover {
                border-color: var(--primary-pink);
                color: var(--primary-pink);
                background: rgba(214, 138, 138, 0.1);
            }

        /* زر Add to Cart - موقت */
        .btn-add-cart {
            background: var(--primary-pink);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }

            .btn-add-cart:hover {
                background: #c27676;
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(214, 138, 138, 0.2);
            }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 4rem;
            color: var(--primary-pink);
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Pagination */
        .pagination {
            margin-top: 50px;
            justify-content: center;
        }

        .page-link {
            background: var(--card-bg);
            border: 1px solid #333;
            color: var(--text-light);
            padding: 10px 18px;
            margin: 0 5px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

            .page-link:hover {
                border-color: var(--primary-pink);
                color: var(--primary-pink);
            }

        .page-item.active .page-link {
            background: var(--primary-pink);
            border-color: var(--primary-pink);
            color: white;
        }

        .page-item.disabled .page-link {
            background: #222;
            border-color: #333;
            color: #666;
        }

        /* Responsive Design */
        @@media (max-width: 768px) {
            .shop-title {
                font-size: 2rem;
            }

            .filter-section {
                padding: 20px;
            }

            .product-name {
                font-size: 1.1rem;
                height: 50px;
            }

            .product-description {
                height: 70px;
                font-size: 0.9rem;
            }
        }
    </style>
}

<div class="shop-header">
    <div class="container">
        <h1 class="shop-title">Pro Makeup Studio Collection</h1>
        <p class="shop-subtitle">Discover our luxurious selection of professional makeup products</p>
    </div>
</div>

<div class="container">
    <!-- Filter Section -->
    <div class="filter-section">
        <form id="filterForm" method="get" asp-action="GetAllProducts" class="row g-3">
            <div class="col-12 col-lg-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text"
                           name="search"
                           value="@searchTerm"
                           class="form-control form-control-custom"
                           placeholder="Search for luxury products..."
                           aria-label="Search products">
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <select name="sortBy" class="form-select form-control-custom auto-submit">
                    <option value="id" selected="@(sortBy == "id")">Newest First</option>
                    <option value="name" selected="@(sortBy == "name")">Name (A to Z)</option>
                </select>
            </div>
            <div class="col-6 col-lg-3">
                <select name="sortDir" class="form-select form-control-custom auto-submit">
                    <option value="asc" selected="@(sortDir == "asc")">Ascending</option>
                    <option value="desc" selected="@(sortDir == "desc")">Descending</option>
                </select>
            </div>
        </form>
    </div>

    <!-- Products Grid -->
    <div class="row g-4">
        @if (Model.Items != null && Model.Items.Any())
        {
            @foreach (var product in Model.Items)
            {
                <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                    <div class="product-card">
                        <!-- Product Image -->
                        <div class="img-wrapper">
                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                            {
                                <img src="@product.ImageUrl"
                                     class="product-img"
                                     alt="@product.Name"
                                     loading="lazy"
                                     onerror="this.src='https://via.placeholder.com/400x400/1a1a1a/d68a8a?text=Pro+Makeup+Studio'">
                            }
                            else
                            {
                                <div class="d-flex flex-column align-items-center justify-content-center text-center text-muted h-100">
                                    <i class="bi bi-image fs-1 mb-2"></i>
                                    <small>No Image</small>
                                </div>
                            }
                        </div>

                        <!-- Product Info -->
                        <div class="product-info">
                            <!-- Admin Actions -->
                            @if (User.IsInRole("Admin"))
                            {
                                <div class="admin-actions">
                                    <a asp-action="Edit"
                                       asp-route-id="@product.Id"
                                       class="btn-admin btn-edit"
                                       title="Edit Product">
                                        <i class="bi bi-pencil"></i>
                                        <span>Edit</span>
                                    </a>
                                    <a asp-action="Delete"
                                       asp-route-id="@product.Id"
                                       class="btn-admin btn-delete"
                                       title="Delete Product"
                                       onclick="return confirm('Are you sure you want to delete this luxurious product? This action cannot be undone.')">
                                        <i class="bi bi-trash"></i>
                                        <span>Delete</span>
                                    </a>
                                </div>
                            }

                            <!-- Product Name -->
                            <h3 class="product-name" title="@product.Name">
                                @product.Name
                            </h3>

                            <!-- Product Description -->
                            @if (!string.IsNullOrEmpty(product.Description))
                            {
                                <div class="product-description" title="@product.Description">
                                    @{
                                        var shortDescription = product.Description.Length > 150
                                        ? product.Description.Substring(0, 150) + "..."
                                        : product.Description;
                                    }
                                    @shortDescription
                                </div>
                            }
                            else
                            {
                                <div class="product-description text-muted">
                                    <i>No description available</i>
                                </div>
                            }

                            <!-- Product Actions -->
                            <div class="product-actions">
                                <!-- View Details Button -->
                                <a asp-action="Details"
                                   asp-route-id="@product.Id"
                                   class="btn-details">
                                    <i class="bi bi-eye"></i>
                                    <span>View Details</span>
                                </a>

                                <!-- Add to Basket Form -->
                                <form asp-controller="basket"
                                      asp-action="AddToBasket"
                                      method="post"
                                      class="add-to-basket-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="ProductId" value="@product.Id" />
                                    <input type="hidden" name="ProductName" value="@product.Name" />
                                    <!-- Note: Price and Stock removed from DTO -->
                                    <input type="hidden" name="Quantity" value="1" />

                                    <button type="submit" class="btn-add-cart">
                                        <i class="bi bi-bag-plus"></i>
                                        <span>Add to Luxury Bag</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <!-- Empty State -->
            <div class="col-12">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-search"></i>
                    </div>
                    <h3 class="mb-3">No Products Found</h3>
                    <p class="text-muted mb-4">
                        @if (!string.IsNullOrEmpty(searchTerm))
                        {
                            <span>No results found for "<strong>@searchTerm</strong>". Try a different search term.</span>
                        }
                        else
                        {
                            <span>There are currently no products available in our luxury collection.</span>
                        }
                    </p>
                    @if (!string.IsNullOrEmpty(searchTerm))
                    {
                        <a asp-action="GetAllProducts" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-left me-2"></i>
                            Clear Search
                        </a>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Pagination -->
    @if (Model.TotalPages > 1)
    {
        <nav class="pagination-section">
            <ul class="pagination">
                <!-- Previous Page -->
                <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="GetAllProducts"
                       asp-route-pageIndex="@(Model.PageNumber - 1)"
                       asp-route-search="@searchTerm"
                       asp-route-sortBy="@sortBy"
                       asp-route-sortDir="@sortDir"
                       aria-label="Previous">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>

                <!-- Page Numbers -->
                @for (int i = 1; i <= Model.TotalPages; i++)
                {
                    if (i == 1 || i == Model.TotalPages || (i >= Model.PageNumber - 2 && i <= Model.PageNumber + 2))
                    {
                        <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                            <a class="page-link"
                               asp-action="GetAllProducts"
                               asp-route-pageIndex="@i"
                               asp-route-search="@searchTerm"
                               asp-route-sortBy="@sortBy"
                               asp-route-sortDir="@sortDir">
                                @i
                            </a>
                        </li>
                    }
                    else if (i == Model.PageNumber - 3 || i == Model.PageNumber + 3)
                    {
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    }
                }

                <!-- Next Page -->
                <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="GetAllProducts"
                       asp-route-pageIndex="@(Model.PageNumber + 1)"
                       asp-route-search="@searchTerm"
                       asp-route-sortBy="@sortBy"
                       asp-route-sortDir="@sortDir"
                       aria-label="Next">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            </ul>

            <!-- Page Info -->
            <div class="text-center text-muted mt-3">
                Showing page @Model.PageNumber of @Model.TotalPages
                @if (Model.Items != null && Model.Items.Any())
                {
                    <span class="mx-2">•</span>
                    <span>@@Model.Items.Count items</span>
                }
            </div>
        </nav>
    }
</div>

@section Scripts {
    <script>
        // Auto-submit filter form when selects change
        document.querySelectorAll('.auto-submit').forEach(select => {
            select.addEventListener('change', () => {
                document.getElementById('filterForm').submit();
            });
        });

        // Handle Add to Basket form submission
        document.querySelectorAll('.add-to-basket-form').forEach(form => {
            form.addEventListener('submit', function(event) {
                const button = this.querySelector('.btn-add-cart');
                const originalText = button.innerHTML;

                // Show loading state
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> <span>Adding...</span>';
                button.disabled = true;

                // Submit form
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // Show success message
                        button.innerHTML = '<i class="bi bi-check-circle"></i> <span>Added!</span>';
                        button.style.background = 'var(--success-green)';

                        // Reset button after 2 seconds
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.disabled = false;
                            button.style.background = '';
                        }, 2000);
                    } else {
                        // Show error
                        button.innerHTML = '<i class="bi bi-exclamation-circle"></i> <span>Error</span>';
                        button.style.background = 'var(--danger-red)';

                        // Reset button after 3 seconds
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.disabled = false;
                            button.style.background = '';
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    button.innerHTML = '<i class="bi bi-exclamation-circle"></i> <span>Error</span>';
                    button.style.background = 'var(--danger-red)';

                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        button.style.background = '';
                    }, 3000);
                });

                event.preventDefault();
            });
        });

        // Lazy loading images
        const lazyImages = document.querySelectorAll('.product-img');

        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src || img.src;
                    observer.unobserve(img);
                }
            });
        });

        lazyImages.forEach(img => {
            if (!img.complete) {
                imageObserver.observe(img);
            }
        });
    </script>
}
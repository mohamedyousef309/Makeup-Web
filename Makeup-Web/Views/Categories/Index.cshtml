@model List<Domain_Layer.ViewModels.CategoriesViewModel.CategoryViewModel>

@{
    ViewData["Title"] = "Categories Management";
    Layout = "_Layout";
}

@Html.AntiForgeryToken()

@section Styles {
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-hover: linear-gradient(135deg, #5a6fd8 0%, #6a4391 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --card-border: #334155;
            --table-header: rgba(30, 41, 59, 0.9);
            --table-row: rgba(255, 255, 255, 0.02);
            --table-hover: rgba(102, 126, 234, 0.1);
            --text-light: #f1f5f9;
            --text-muted: #94a3b8;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 10px 30px rgba(0, 0, 0, 0.2);
            --shadow-sm: 0 5px 15px rgba(0, 0, 0, 0.1);
            --glow: 0 0 40px rgba(139, 92, 246, 0.2);
        }

        body {
            background: var(--dark-bg);
            color: var(--text-light);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-image: radial-gradient(at 10% 20%, rgba(102, 126, 234, 0.1) 0%, transparent 50%), radial-gradient(at 90% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            min-height: 100vh;
        }

        .page-header {
            padding: 40px 0 30px;
            position: relative;
            overflow: hidden;
        }

            .page-header::before {
                content: '';
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 1px;
                background: linear-gradient(90deg, transparent, var(--accent-purple), transparent);
            }

        .page-title {
            font-family: 'Poppins', sans-serif;
            font-size: 2.8rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
            letter-spacing: 1px;
        }

            .page-title::after {
                content: '';
                position: absolute;
                bottom: -8px;
                left: 0;
                width: 120px;
                height: 4px;
                background: var(--primary-gradient);
                border-radius: 2px;
                box-shadow: var(--glow);
            }

        .dashboard-card {
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

            .dashboard-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 5px;
                background: var(--primary-gradient);
            }

        .card-header {
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 25px 30px;
            position: relative;
        }

            .card-header h3 {
                font-weight: 700;
                font-size: 1.5rem;
                margin: 0;
                display: flex;
                align-items: center;
                gap: 10px;
            }

                .card-header h3 i {
                    background: var(--primary-gradient);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                    font-size: 1.8rem;
                }

        .btn-primary-custom {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .btn-primary-custom::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: 0.6s;
            }

            .btn-primary-custom:hover {
                transform: translateY(-3px);
                box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
                background: var(--primary-hover);
            }

                .btn-primary-custom:hover::before {
                    left: 100%;
                }

        .category-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

            .category-table thead th {
                background: rgba(30, 41, 59, 0.95);
                color: var(--text-light);
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.8px;
                font-size: 0.85rem;
                padding: 20px 15px;
                border-bottom: 2px solid var(--accent-purple);
                position: sticky;
                top: 0;
                backdrop-filter: blur(10px);
            }

                .category-table thead th:first-child {
                    border-top-left-radius: 15px;
                }

                .category-table thead th:last-child {
                    border-top-right-radius: 15px;
                }

            .category-table tbody tr {
                background: rgba(255, 255, 255, 0.01);
                transition: all 0.3s ease;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

                .category-table tbody tr:hover {
                    background: rgba(102, 126, 234, 0.1);
                    transform: translateX(5px);
                    box-shadow: var(--shadow-sm);
                }

                .category-table tbody tr td {
                    padding: 20px 15px;
                    color: var(--text-light);
                    vertical-align: middle;
                }

                .category-table tbody tr:last-child {
                    border-bottom: none;
                }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: var(--shadow-sm);
        }

            .category-icon i {
                color: white;
                font-size: 1.2rem;
            }

        .btn-action {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-edit {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

            .btn-edit:hover {
                background: rgba(16, 185, 129, 0.2);
                border-color: var(--success);
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
                color: white;
            }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

            .btn-delete:hover {
                background: rgba(239, 68, 68, 0.2);
                border-color: var(--danger);
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(239, 68, 68, 0.2);
                color: white;
            }

        .empty-state {
            padding: 60px 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 20px;
            margin: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.1);
        }

            .empty-state i {
                font-size: 4rem;
                background: var(--primary-gradient);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                margin-bottom: 20px;
            }

        .stats-badge {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            padding: 10px 25px;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }

        /* Modal Styling */
        .delete-modal .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }

        .delete-modal .modal-header {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
            border-bottom: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 20px 20px 0 0;
            padding: 25px 30px;
        }

        .delete-modal .modal-body {
            padding: 30px;
        }

        .delete-modal .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding: 20px 30px;
            border-radius: 0 0 20px 20px;
        }

        /* Animations */
        @@keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dashboard-card {
            animation: fadeInUp 0.6s ease-out;
        }

        @@keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .category-table tbody tr {
            animation: slideInRight 0.5s ease-out forwards;
            opacity: 0;
        }

            .category-table tbody tr:nth-child(1) {
                animation-delay: 0.1s;
            }

            .category-table tbody tr:nth-child(2) {
                animation-delay: 0.2s;
            }

            .category-table tbody tr:nth-child(3) {
                animation-delay: 0.3s;
            }

            .category-table tbody tr:nth-child(4) {
                animation-delay: 0.4s;
            }

            .category-table tbody tr:nth-child(5) {
                animation-delay: 0.5s;
            }

            .category-table tbody tr:nth-child(6) {
                animation-delay: 0.6s;
            }

        /* Toast Notifications */
        .custom-toast {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 10px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--primary-hover);
            }

        /* Responsive */
        @@media (max-width: 768px) {
            .page-title {
                font-size: 2.2rem;
            }

            .dashboard-card {
                border-radius: 15px;
                margin: 0 10px 20px;
            }

            .btn-action {
                width: 100%;
                justify-content: center;
                margin-bottom: 10px;
            }

            .category-table thead {
                display: none;
            }

            .category-table tbody tr {
                display: block;
                margin-bottom: 20px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 15px;
                padding: 15px;
            }

                .category-table tbody tr td {
                    display: flex;
                    justify-content: space-between;
                    padding: 10px 0;
                    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                }

                    .category-table tbody tr td:before {
                        content: attr(data-label);
                        font-weight: 600;
                        color: var(--text-muted);
                        text-transform: uppercase;
                        font-size: 0.8rem;
                        margin-right: 15px;
                    }

                    .category-table tbody tr td:last-child {
                        border-bottom: none;
                    }
        }
    </style>
}

<div class="container-fluid">
    <div class="page-header">
        <div class="container">
            <h1 class="page-title">Categories Management</h1>
            <p class="text-muted mt-2" style="font-size: 1.1rem;">Organize and manage your product categories</p>
        </div>
    </div>

    <div class="container">
        <!-- رسائل التنبيه -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert" style="border-radius: 15px; backdrop-filter: blur(10px);">
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <strong>Success!</strong> @TempData["SuccessMessage"]
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        }

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert" style="border-radius: 15px; backdrop-filter: blur(10px);">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-3" style="font-size: 1.5rem;"></i>
                    <div class="flex-grow-1">
                        <strong>Error!</strong> @TempData["ErrorMessage"]
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        }

        <div class="dashboard-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>
                    <i class="bi bi-diagram-3"></i> Categories Dashboard
                </h3>
                <a asp-action="Create" class="btn-primary-custom">
                    <i class="bi bi-plus-circle"></i> Add New Category
                </a>
            </div>

            <div class="card-body">
                @if (Model == null || !Model.Any())
                {
                    <div class="empty-state">
                        <i class="bi bi-inboxes"></i>
                        <h4 class="mt-3 mb-2">No Categories Found</h4>
                        <p class="text-muted mb-4">Get started by creating your first category</p>
                        <a asp-action="Create" class="btn-primary-custom">
                            <i class="bi bi-plus-circle"></i> Create First Category
                        </a>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="category-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Category Name</th>
                                    <th>Description</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < Model.Count; i++)
                                {
                                    var category = Model[i];
                                    <tr>
                                        <td data-label="#">
                                            <span class="fw-bold" style="color: var(--accent-purple);">@(i + 1)</span>
                                        </td>
                                        <td data-label="Category Name">
                                            <div class="d-flex align-items-center">
                                                <div class="category-icon">
                                                    <i class="bi bi-folder"></i>
                                                </div>
                                                <div>
                                                    <span class="fw-bold">@category.Name</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td data-label="Description">
                                            @if (!string.IsNullOrEmpty(category.Description))
                                            {
                                                <div class="text-truncate" style="max-width: 300px;"
                                                     data-bs-toggle="tooltip"
                                                     data-bs-placement="top"
                                                     title="@category.Description">
                                                    @category.Description
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted fst-italic">No description provided</span>
                                            }
                                        </td>
                                        <td data-label="Actions" class="text-center">
                                            <div class="d-flex justify-content-center gap-3">
                                                <a asp-action="Edit" asp-route-id="@category.Id"
                                                   class="btn btn-action btn-edit"
                                                   data-bs-toggle="tooltip"
                                                   data-bs-placement="top"
                                                   title="Edit category">
                                                    <i class="bi bi-pencil-square"></i> Edit
                                                </a>

                                                <button type="button"
                                                        class="btn btn-action btn-delete delete-btn"
                                                        data-id="@category.Id"
                                                        data-name="@category.Name"
                                                        data-bs-toggle="tooltip"
                                                        data-bs-placement="top"
                                                        title="Delete category">
                                                    <i class="bi bi-trash"></i> Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top" style="border-color: rgba(255,255,255,0.05) !important;">
                        <div class="stats-badge">
                            <i class="bi bi-collection"></i>
                            <span>Total Categories: <strong>@Model.Count</strong></span>
                        </div>
                        <div class="text-muted">
                            <small>Last updated: @DateTime.Now.ToString("MMM dd, yyyy HH:mm")</small>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade delete-modal" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, rgba(239,68,68,0.2) 0%, rgba(220,38,38,0.2) 100%); display: inline-flex; align-items: center; justify-content: center;">
                        <i class="bi bi-trash-fill text-danger" style="font-size: 2.5rem;"></i>
                    </div>
                </div>

                <h5 class="text-center mb-3">Are you sure you want to delete this category?</h5>

                <div class="alert alert-warning border-0" style="background: rgba(245,158,11,0.1); border-left: 4px solid var(--warning);">
                    <div class="d-flex">
                        <i class="bi bi-info-circle-fill me-2" style="color: var(--warning);"></i>
                        <div>
                            <strong class="d-block">Category to delete:</strong>
                            <span id="deleteCategoryName" class="fw-bold text-danger" style="font-size: 1.1rem;"></span>
                        </div>
                    </div>
                </div>

                <div class="alert alert-dark border-0 mt-3" style="background: rgba(255,255,255,0.05);">
                    <small class="text-muted">
                        <i class="bi bi-lightbulb me-1"></i>
                        This action will permanently remove the category and cannot be undone.
                        Any products associated with this category will need to be reassigned.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 12px 25px;">
                    <i class="bi bi-x-circle me-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" style="border-radius: 10px; padding: 12px 25px;">
                    <i class="bi bi-check-circle me-1"></i> Delete Category
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize Bootstrap tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Variables to store delete data
            let categoryToDelete = {
                id: null,
                name: null
            };

            // When delete button is clicked
            $(document).on('click', '.delete-btn', function () {
                // Store category data
                categoryToDelete.id = $(this).data('id');
                categoryToDelete.name = $(this).data('name');

                // Update modal content
                $('#deleteCategoryName').text(categoryToDelete.name);

                // Show modal
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
                deleteModal.show();
            });

            // Confirm delete button click
            $('#confirmDeleteBtn').click(function () {
                if (!categoryToDelete.id) return;

                // Disable button and show loading
                const deleteBtn = $(this);
                const originalText = deleteBtn.html();
                deleteBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span> Deleting...');

                // Get the anti-forgery token
                const token = $('input[name="__RequestVerificationToken"]').val();

                // Send AJAX request
                $.ajax({
                    url: '/Categories/Delete',
                    type: 'POST',
                    data: {
                        id: categoryToDelete.id,
                        __RequestVerificationToken: token
                    },
                    success: function (response) {
                        // Reset button
                        deleteBtn.prop('disabled', false).html(originalText);

                        if (response.success) {
                            // Show success message
                            showNotification('success', response.message);

                            // Hide modal
                            bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal')).hide();

                            // Remove row from table after a delay
                            setTimeout(function () {
                                const row = $(`.delete-btn[data-id="${categoryToDelete.id}"]`).closest('tr');
                                row.css('background', 'rgba(239, 68, 68, 0.1)');
                                row.fadeOut(500, function () {
                                    $(this).remove();
                                    // Update row numbers
                                    updateRowNumbers();
                                    // Show message if no categories left
                                    checkEmptyTable();
                                });
                            }, 800);
                        } else {
                            // Show error message
                            showNotification('error', response.message);

                            // Hide modal
                            bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal')).hide();
                        }
                    },
                    error: function (xhr, status, error) {
                        // Reset button
                        deleteBtn.prop('disabled', false).html(originalText);

                        // Show error message
                        showNotification('error', 'An error occurred while deleting the category. Please try again.');
                    }
                });
            });

            // Function to update row numbers after deletion
            function updateRowNumbers() {
                $('tbody tr').each(function (index) {
                    $(this).find('td:first span').text(index + 1);
                });
            }

            // Function to check if table is empty
            function checkEmptyTable() {
                if ($('tbody tr').length === 0) {
                    const emptyHtml = `
                        <div class="empty-state">
                            <i class="bi bi-inboxes"></i>
                            <h4 class="mt-3 mb-2">No Categories Found</h4>
                            <p class="text-muted mb-4">All categories have been deleted</p>
                            <a href="/Categories/Create" class="btn-primary-custom">
                                <i class="bi bi-plus-circle"></i> Create New Category
                            </a>
                        </div>
                    `;
                    $('tbody').parent().parent().html(emptyHtml);
                }
            }

            // Function to show notifications
            function showNotification(type, message) {
                const notificationId = 'notification-' + Date.now();
                const notificationHtml = `
                    <div id="${notificationId}" class="position-fixed top-0 end-0 p-4" style="z-index: 9999; min-width: 300px;">
                        <div class="custom-toast ${type === 'success' ? 'bg-success' : 'bg-danger'} text-white border-0" role="alert">
                            <div class="d-flex">
                                <div class="toast-body p-4">
                                    <div class="d-flex align-items-center">
                                        <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'} me-3" style="font-size: 1.5rem;"></i>
                                        <div>
                                            <strong>${type === 'success' ? 'Success!' : 'Error!'}</strong>
                                            <div class="mt-1">${message}</div>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn-close btn-close-white me-3 m-auto" data-bs-dismiss="toast"></button>
                            </div>
                        </div>
                    </div>
                `;

                $('body').append(notificationHtml);
                const toastElement = document.getElementById(notificationId).querySelector('.custom-toast');
                const toast = new bootstrap.Toast(toastElement, {
                    autohide: true,
                    delay: 5000
                });
                toast.show();

                // Remove after hiding
                toastElement.addEventListener('hidden.bs.toast', function () {
                    $('#' + notificationId).remove();
                });
            }

            // Auto-hide alerts after 5 seconds
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000);
        });
    </script>
}